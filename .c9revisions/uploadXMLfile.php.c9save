{"ts":1353874012268,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n\n/*     \n    more here:\n    http://www.php.net/manual/en/features.file-upload.post-method.php\n    http://www.php.net/manual/en/features.file-upload.errors.php\n    http://www.php.net/manual/en/features.file-upload.common-pitfalls.php\n    \n    http://www.w3schools.com/php/php_file_upload.asp\n    \n    http://www.php.net/manual/en/simplexml.examples-basic.php\n    \n            /*\n            first save file\n            The file will be deleted from the temporary directory at the end of the request if it has not been moved away or renamed.\n            Also, files uploaded by other users should not be accessible\n            So, maybe remane the file to something_usersessionID ?\n            and delete it in the end of the session?\n            and delete also all other files, created for download on the filtering page\n            */ \n    \n\n\n    session_start();\n\n    $userFile = $_FILES['userFile'];    \n    define(\"UPLOAD_ERR_EMPTY\", 5);\n    define(\"UPLOAD_ERR_NO_XML\", 9);\n\n    checkUploadErrors();\n    checkFileType();\n    checkXMLvalid();\n    \n//  get result and put it in session!\n      \n//    header('Location: filterpage.php');\n//    exit;    \n    \n    //TODO set a custom limit for size?\n    function checkUploadErrors()\n    {\n        global $userFile;\n         \n        if($userFile['size'] == 0 && $userFile['error'] == 0)\n        {\n            $userFile['error'] = UPLOAD_ERR_EMPTY;\n        }\n        \n        if ($userFile['error'] > 0 || $userFile['size'] == 0)\n        {        \n            showError();\n        }        \n    }\n    \n    function checkFileType()\n    {\n        global $userFile;\n        $userFileExtension = end(explode('.', $userFile['name']));\n        $userFileExtension = strtolower($userFileExtension);\n        \n        $allowedMimeTypes = array('text/xml','application/xml','application/x-xml');\n        \n        $fileName = $userFile['tmp_name'];\n        $finfo = finfo_open(FILEINFO_MIME_TYPE);\n        $userFileMime = finfo_file($finfo, $fileName);\n        finfo_close($finfo);\n               \n        if($userFileExtension != 'xml' || !in_array($userFileMime, $allowedMimeTypes)) \n        {  \n            $userFile['error'] = UPLOAD_ERR_NO_XML;\n            $userFile['type'] = $userFileMime;\n            showError();\n        }\n    }\n \n    function checkXMLvalid()\n    {\n        global $userFile;\n        $fileName = $userFile['tmp_name'];\n        $root = simplexml_load_file($fileName);\n        if ($root === false)\n        {\n            $userFile['error'] = UPLOAD_ERR_NO_XML;\n            showError();\n        }\n        else\n        {\n\t\t\techo 'xml ok';\n            //print_r($root);\n//            $_SESSION['root'] = $root;\n            $_SESSION['ra'] = 'raka';\n           header('Location: filterpage.php');\n            exit;\n        }\n    }    \n    \n    function showError()\n    {        \n        global $userFile;      \n        \n        $errorCode = $userFile['error'];\n        $mimeType = $userFile['type'];\n        $mimeParameter = (empty($mimeType)) ? \"\" : \"&mime=$mimeType\" ;\n        header(\"Location: errorpage.php?err=$errorCode\".$mimeParameter);\n        exit;\n    }\n?> "]],"start1":0,"start2":0,"length1":0,"length2":3127}]],"length":3127}
